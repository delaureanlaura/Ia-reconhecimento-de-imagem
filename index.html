<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector Final - CodeMinds</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f4f4f9; padding: 20px; }
        #camera-box { 
            width: 320px; height: 240px; 
            background: #000; 
            margin: 20px auto; 
            border-radius: 12px; 
            border: 5px solid #333;
            overflow: hidden;
            position: relative;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        #status-msg { font-size: 18px; color: #555; margin-bottom: 10px; font-weight: bold; }
        #resultado { font-size: 24px; font-weight: bold; margin: 20px; padding: 15px; border-radius: 8px; }
        .btn { 
            padding: 15px 30px; font-size: 18px; 
            background: #007bff; color: white; 
            border: none; border-radius: 8px; cursor: pointer;
        }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .aviso-erro { color: red; background: #ffdddd; padding: 10px; border: 1px solid red; display: none; }
    </style>
</head>
<body>

    <h1>Detector de Celular üì±</h1>
    <div id="status-msg">üîÑ Conectando aos servidores do Google...</div>
    
    <div id="erro-bloqueio" class="aviso-erro">
        ‚ö†Ô∏è <b>ALERTA DE BLOQUEIO:</b><br>
        O navegador impediu o carregamento da IA.<br>
        1. Desative o üõ°Ô∏è Escudo de Bloqueio do Opera.<br>
        2. Recarregue a p√°gina.
    </div>

    <div id="camera-box">
        <video id="video" autoplay playsinline muted></video>
    </div>

    <div id="resultado">Aguardando IA...</div>
    <button id="btn-start" class="btn" onclick="iniciar()" disabled>CARREGANDO SISTEMA...</button>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script>
        const URL_MODELO = "https://teachablemachine.withgoogle.com/models/9QexMYusB/";
        let model, maxPredictions;
        let carregou = false;

        // VERIFICA√á√ÉO DE SEGURAN√áA (Roda a cada 1 segundo)
        let tentativas = 0;
        const check = setInterval(() => {
            tentativas++;
            // Se as bibliotecas existirem, libera o sistema
            if (typeof tmImage !== 'undefined' && typeof tf !== 'undefined') {
                clearInterval(check);
                carregou = true;
                sistemaPronto();
            }
            // Se passar 8 segundos e nada, mostra aviso de bloqueio
            else if (tentativas > 8) {
                document.getElementById('erro-bloqueio').style.display = 'block';
                document.getElementById('status-msg').innerText = "‚ùå Falha no download.";
            }
        }, 1000);

        function sistemaPronto() {
            const btn = document.getElementById('btn-start');
            btn.innerText = "LIGAR C√ÇMERA";
            btn.disabled = false;
            btn.style.background = "#28a745";
            document.getElementById('status-msg').innerText = "‚úÖ Sistema Carregado!";
        }

        async function iniciar() {
            if (!carregou) return alert("A IA n√£o carregou. Verifique sua internet ou bloqueadores.");
            
            const btn = document.getElementById('btn-start');
            const video = document.getElementById('video');
            
            btn.disabled = true;
            btn.innerText = "INICIANDO...";

            try {
                // 1. Liga Webcam
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                video.srcObject = stream;

                // 2. Carrega Modelo
                model = await tmImage.load(URL_MODELO + "model.json", URL_MODELO + "metadata.json");
                maxPredictions = model.getTotalClasses();

                btn.style.display = 'none'; // Some bot√£o
                document.getElementById('status-msg').innerText = "üé• Monitorando...";
                loop(); // Inicia loop

            } catch (e) {
                alert("Erro: " + e.message);
                btn.disabled = false;
                btn.innerText = "TENTAR NOVAMENTE";
            }
        }

        async function loop() {
            if (model) {
                const video = document.getElementById('video');
                const prediction = await model.predict(video);
                
                let celular = false;
                // Procura a classe "Com celular"
                for (let i = 0; i < maxPredictions; i++) {
                    if (prediction[i].className === "Com celular" && prediction[i].probability > 0.85) {
                        celular = true;
                    }
                }

                const res = document.getElementById('resultado');
                if (celular) {
                    document.body.style.backgroundColor = "#ff4d4d";
                    res.innerText = "‚ö†Ô∏è SOLTA O CELULAR!";
                    res.style.color = "white";
                } else {
                    document.body.style.backgroundColor = "#d4edda";
                    res.innerText = "‚úÖ FOCO MANTIDO";
                    res.style.color = "green";
                }
            }
            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
